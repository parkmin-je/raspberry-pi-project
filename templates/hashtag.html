{% extends "base.html" %}

{% block title %}#{{ hashtag.tag }} / Twitter{% endblock %}

{% block content %}
<div class="twitter-container">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <div class="left-sidebar">
        <a href="{{ url_for('timeline') }}" class="logo">
            ğŸ¦
        </a>
        
        <nav>
            <a href="{{ url_for('timeline') }}" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-text">í™ˆ</span>
            </a>
            
            <a href="{{ url_for('explore') }}" class="nav-item">
                <span class="nav-icon">ğŸ”</span>
                <span class="nav-text">íƒìƒ‰í•˜ê¸°</span>
            </a>
            
            <a href="{{ url_for('trending') }}" class="nav-item active">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text">íŠ¸ë Œë“œ</span>
            </a>
            
            <a href="{{ url_for('notifications') }}" class="nav-item">
                <span class="nav-icon">ğŸ””</span>
                <span class="nav-text">ì•Œë¦¼</span>
                {% if user.unread_notifications_count() > 0 %}
                <span style="background: var(--twitter-blue); color: white; border-radius: 50%; padding: 2px 8px; font-size: 12px; margin-left: 8px;">
                    {{ user.unread_notifications_count() }}
                </span>
                {% endif %}
            </a>
            
            <a href="{{ url_for('messages') }}" class="nav-item">
                <span class="nav-icon">âœ‰ï¸</span>
                <span class="nav-text">ìª½ì§€</span>
                {% if user.unread_messages_count() > 0 %}
                <span style="background: var(--twitter-blue); color: white; border-radius: 50%; padding: 2px 8px; font-size: 12px; margin-left: 8px;">
                    {{ user.unread_messages_count() }}
                </span>
                {% endif %}
            </a>
            
            <a href="{{ url_for('bookmarks') }}" class="nav-item">
                <span class="nav-icon">ğŸ”–</span>
                <span class="nav-text">ë¶ë§ˆí¬</span>
            </a>
            
            <a href="{{ url_for('users_list') }}" class="nav-item">
                <span class="nav-icon">ğŸ‘¥</span>
                <span class="nav-text">ì‚¬ìš©ì</span>
            </a>
            
            <a href="{{ url_for('profile') }}" class="nav-item">
                <span class="nav-icon">ğŸ‘¤</span>
                <span class="nav-text">í”„ë¡œí•„</span>
            </a>
            
            <a href="{{ url_for('logout') }}" class="nav-item">
                <span class="nav-icon">ğŸšª</span>
                <span class="nav-text">ë¡œê·¸ì•„ì›ƒ</span>
            </a>
        </nav>
    </div>
    
    <!-- ì¤‘ì•™ í”¼ë“œ -->
    <div class="main-feed">
        <div class="feed-header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <a href="{{ url_for('trending') }}" style="text-decoration: none; color: var(--text-primary);">
                    <button style="background: none; border: none; font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%;">â†</button>
                </a>
                <div>
                    <div style="font-size: 20px; font-weight: bold;">#{{ hashtag.tag }}</div>
                    <div style="color: var(--text-secondary); font-size: 13px;">{{ hashtag.tweet_count() }}ê°œì˜ íŠ¸ìœ—</div>
                </div>
            </div>
        </div>
        
        <!-- í•´ì‹œíƒœê·¸ ì •ë³´ -->
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
            <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">#{{ hashtag.tag }}</div>
            <div style="color: var(--text-secondary); font-size: 15px;">
                {{ hashtag.created_at.strftime('%Yë…„ %mì›” %dì¼') }}ë¶€í„° íŠ¸ë Œë“œ
            </div>
        </div>
        
        <!-- íŠ¸ìœ— ëª©ë¡ -->
        <div id="hashtag-tweets">
            {% if tweets %}
                {% for tweet in tweets %}
                <div class="tweet-card" data-tweet-id="{{ tweet.id }}">
                    <div class="tweet-content-wrapper">
                        <div class="avatar">
                            {{ tweet.author.name[0] if tweet.author.name else 'U' }}
                        </div>
                        
                        <div class="tweet-body">
                            <div class="tweet-header">
                                <a href="{{ url_for('user_profile', username=tweet.author.username) }}" style="text-decoration: none;">
                                    <span class="tweet-author">{{ tweet.author.name }}</span>
                                    <span class="tweet-username">@{{ tweet.author.username }}</span>
                                </a>
                                <span class="tweet-dot">Â·</span>
                                <span class="tweet-time">{{ tweet.created_at.strftime('%mì›” %dì¼') }}</span>
                            </div>
                            
                            <div class="tweet-text">
                                {{ tweet.content | safe | replace('#' + hashtag.tag, '<span style="color: var(--twitter-blue); font-weight: 500;">#' + hashtag.tag + '</span>') }}
                            </div>
                            
                            <div class="tweet-actions">
                                <button class="action-button reply" onclick="showReplyModal({{ tweet.id }}, '{{ tweet.author.name }}', '{{ tweet.content[:50] }}')">
                                    <span class="icon">ğŸ’¬</span>
                                    <span class="count">{{ tweet.replies_count() }}</span>
                                </button>
                                
                                <button class="action-button retweet {% if tweet.is_retweeted_by(user) %}active{% endif %}" onclick="toggleRetweet({{ tweet.id }}, this)">
                                    <span class="icon">ğŸ”</span>
                                    <span class="count">{{ tweet.retweets_count() }}</span>
                                </button>
                                
                                <button class="action-button like {% if tweet.is_liked_by(user) %}active{% endif %}" onclick="toggleLike({{ tweet.id }}, this)">
                                    <span class="icon">{% if tweet.is_liked_by(user) %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                                    <span class="count">{{ tweet.likes_count() }}</span>
                                </button>
                                
                                <button class="action-button bookmark {% if tweet.is_bookmarked_by(user) %}active{% endif %}" onclick="toggleBookmark({{ tweet.id }}, this)">
                                    <span class="icon">{% if tweet.is_bookmarked_by(user) %}ğŸ”–{% else %}ğŸ“‘{% endif %}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Œ</div>
                    <h3 style="margin-bottom: 8px;">ì•„ì§ íŠ¸ìœ—ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>#{{ hashtag.tag }} í•´ì‹œíƒœê·¸ë¥¼ ì‚¬ìš©í•œ ì²« ë²ˆì§¸ íŠ¸ìœ—ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” -->
    <div class="right-sidebar">
        <div class="search-box">
            <form action="{{ url_for('search') }}" method="GET">
                <input type="text" name="q" class="search-input" placeholder="Twitter ê²€ìƒ‰" value="">
            </form>
        </div>
        
        <div class="widget">
            <div class="widget-header">
                ê´€ë ¨ íŠ¸ë Œë“œ
            </div>
            <div class="widget-item">
                <div style="color: var(--text-secondary); font-size: 13px;">í˜„ì¬ íŠ¸ë Œë“œ</div>
                <div style="font-weight: bold; margin: 4px 0;">#{{ hashtag.tag }}</div>
                <div style="color: var(--text-secondary); font-size: 13px;">{{ hashtag.tweet_count() }} íŠ¸ìœ—</div>
            </div>
            <a href="{{ url_for('trending') }}" style="color: var(--twitter-blue); text-decoration: none; padding: 16px; display: block;">
                ë” ë³´ê¸°
            </a>
        </div>
    </div>
</div>

<!-- ë‹µê¸€ ëª¨ë‹¬ -->
<div id="replyModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <button onclick="closeReplyModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%;">âœ•</button>
            <h3 style="font-size: 20px; font-weight: bold;">ë‹µê¸€ ì‘ì„±</h3>
            <div style="width: 36px;"></div>
        </div>
        
        <div style="padding: 16px;">
            <div id="originalTweet" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; color: var(--text-secondary); font-size: 15px;"></div>
            
            <div style="display: flex; gap: 12px;">
                <div class="avatar">{{ user.name[0] if user.name else 'U' }}</div>
                <div style="flex: 1;">
                    <textarea id="replyTextarea" placeholder="ë‹µê¸€ íŠ¸ìœ—í•˜ê¸°" style="width: 100%; border: none; outline: none; font-size: 17px; font-family: inherit; resize: none; min-height: 100px;" maxlength="300"></textarea>
                </div>
            </div>
        </div>
        
        <div style="padding: 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
            <button id="replyButton" class="post-button" onclick="submitReply()">ë‹µê¸€</button>
        </div>
    </div>
</div>

<style>
.action-button.active.like {
    color: #F91880;
}

.action-button.active.like .icon {
    color: #F91880;
}

.action-button.active.retweet {
    color: #17BF63;
}

.action-button.active.retweet .icon {
    color: #17BF63;
}

.action-button.active.bookmark {
    color: var(--twitter-blue);
}
</style>

<script>
let currentReplyTweetId = null;

// ì¢‹ì•„ìš” í† ê¸€
async function toggleLike(tweetId, button) {
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/like/${tweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const icon = button.querySelector('.icon');
            const count = button.querySelector('.count');
            
            if (data.action === 'liked') {
                icon.textContent = 'â¤ï¸';
                button.classList.add('active');
            } else {
                icon.textContent = 'ğŸ¤';
                button.classList.remove('active');
            }
            
            count.textContent = data.count;
        }
    } catch (error) {
        console.error('Error:', error);
    } finally {
        button.disabled = false;
    }
}

// ë¦¬íŠ¸ìœ— í† ê¸€
async function toggleRetweet(tweetId, button) {
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/retweet/${tweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const count = button.querySelector('.count');
            
            if (data.action === 'retweeted') {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
            
            count.textContent = data.count;
        }
    } catch (error) {
        console.error('Error:', error);
    } finally {
        button.disabled = false;
    }
}

// ë¶ë§ˆí¬ í† ê¸€
async function toggleBookmark(tweetId, button) {
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/bookmark/${tweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const icon = button.querySelector('.icon');
            
            if (data.action === 'bookmarked') {
                icon.textContent = 'ğŸ”–';
                button.classList.add('active');
            } else {
                icon.textContent = 'ğŸ“‘';
                button.classList.remove('active');
            }
        }
    } catch (error) {
        console.error('Error:', error);
    } finally {
        button.disabled = false;
    }
}

// ë‹µê¸€ ëª¨ë‹¬ ì—´ê¸°
function showReplyModal(tweetId, authorName, content) {
    currentReplyTweetId = tweetId;
    document.getElementById('originalTweet').innerHTML = `
        <strong>${authorName}</strong>ë‹˜ì—ê²Œ ë³´ë‚´ëŠ” ë‹µê¸€<br>
        <span style="color: var(--text-primary); margin-top: 8px; display: block;">${content}${content.length > 50 ? '...' : ''}</span>
    `;
    document.getElementById('replyModal').style.display = 'flex';
    document.getElementById('replyTextarea').focus();
}

// ë‹µê¸€ ëª¨ë‹¬ ë‹«ê¸°
function closeReplyModal() {
    document.getElementById('replyModal').style.display = 'none';
    document.getElementById('replyTextarea').value = '';
    currentReplyTweetId = null;
}

// ë‹µê¸€ ì œì¶œ
async function submitReply() {
    const content = document.getElementById('replyTextarea').value.trim();
    if (!content) return;
    
    const button = document.getElementById('replyButton');
    button.disabled = true;
    button.textContent = 'ë‹µê¸€ ì¤‘...';
    
    try {
        const response = await fetch(`/api/reply/${currentReplyTweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content })
        });
        
        if (response.ok) {
            closeReplyModal();
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'ë‹µê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
        button.disabled = false;
        button.textContent = 'ë‹µê¸€';
    }
}

// ESCí‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeReplyModal();
    }
});

// ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('replyModal').addEventListener('click', (e) => {
    if (e.target.id === 'replyModal') {
        closeReplyModal();
    }
});
</script>
{% endblock %}
