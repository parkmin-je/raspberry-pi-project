{% extends "base.html" %}

{% block title %}{% if query %}"{{ query }}" ê²€ìƒ‰ ê²°ê³¼{% else %}ê²€ìƒ‰{% endif %} / Twitter{% endblock %}

{% block content %}
<div class="twitter-container">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <div class="left-sidebar">
        <a href="{{ url_for('timeline') }}" class="logo">
            ğŸ¦
        </a>
        
        <nav>
            <a href="{{ url_for('timeline') }}" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-text">í™ˆ</span>
            </a>
            
            <a href="{{ url_for('explore') }}" class="nav-item">
                <span class="nav-icon">ğŸ”</span>
                <span class="nav-text">íƒìƒ‰í•˜ê¸°</span>
            </a>
            
            <a href="{{ url_for('trending') }}" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text">íŠ¸ë Œë“œ</span>
            </a>
            
            <a href="{{ url_for('notifications') }}" class="nav-item">
                <span class="nav-icon">ğŸ””</span>
                <span class="nav-text">ì•Œë¦¼</span>
                {% if user.unread_notifications_count() > 0 %}
                <span style="background: var(--twitter-blue); color: white; border-radius: 50%; padding: 2px 8px; font-size: 12px; margin-left: 8px;">
                    {{ user.unread_notifications_count() }}
                </span>
                {% endif %}
            </a>
            
            <a href="{{ url_for('messages') }}" class="nav-item">
                <span class="nav-icon">âœ‰ï¸</span>
                <span class="nav-text">ìª½ì§€</span>
                {% if user.unread_messages_count() > 0 %}
                <span style="background: var(--twitter-blue); color: white; border-radius: 50%; padding: 2px 8px; font-size: 12px; margin-left: 8px;">
                    {{ user.unread_messages_count() }}
                </span>
                {% endif %}
            </a>
            
            <a href="{{ url_for('bookmarks') }}" class="nav-item">
                <span class="nav-icon">ğŸ”–</span>
                <span class="nav-text">ë¶ë§ˆí¬</span>
            </a>
            
            <a href="{{ url_for('users_list') }}" class="nav-item">
                <span class="nav-icon">ğŸ‘¥</span>
                <span class="nav-text">ì‚¬ìš©ì</span>
            </a>
            
            <a href="{{ url_for('profile') }}" class="nav-item">
                <span class="nav-icon">ğŸ‘¤</span>
                <span class="nav-text">í”„ë¡œí•„</span>
            </a>
            
            <a href="{{ url_for('logout') }}" class="nav-item">
                <span class="nav-icon">ğŸšª</span>
                <span class="nav-text">ë¡œê·¸ì•„ì›ƒ</span>
            </a>
        </nav>
    </div>
    
    <!-- ì¤‘ì•™ í”¼ë“œ -->
    <div class="main-feed">
        <div class="feed-header">
            <div style="padding: 16px;">
                <form action="{{ url_for('search') }}" method="GET" style="width: 100%;">
                    <input 
                        type="text" 
                        name="q" 
                        class="search-input" 
                        placeholder="Twitter ê²€ìƒ‰" 
                        value="{{ query }}"
                        autofocus
                        style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 24px; font-size: 15px;"
                    >
                </form>
            </div>
        </div>
        
        {% if query %}
            <!-- ê²€ìƒ‰ ê²°ê³¼ í—¤ë” -->
            <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color); background: var(--background-secondary);">
                <div style="font-size: 20px; font-weight: bold; margin-bottom: 4px;">
                    "{{ query }}" ê²€ìƒ‰ ê²°ê³¼
                </div>
                <div style="color: var(--text-secondary); font-size: 14px;">
                    íŠ¸ìœ— {{ tweets|length }}ê°œ, í•´ì‹œíƒœê·¸ {{ hashtags|length }}ê°œ
                </div>
            </div>
            
            <!-- íƒ­ ë©”ë‰´ -->
            <div style="display: flex; border-bottom: 1px solid var(--border-color);">
                <button class="search-tab active" onclick="showTab('tweets')">
                    <span class="nav-text">íŠ¸ìœ—</span>
                    <span style="color: var(--text-secondary); margin-left: 4px;">({{ tweets|length }})</span>
                </button>
                <button class="search-tab" onclick="showTab('hashtags')">
                    <span class="nav-text">í•´ì‹œíƒœê·¸</span>
                    <span style="color: var(--text-secondary); margin-left: 4px;">({{ hashtags|length }})</span>
                </button>
            </div>
            
            <!-- íŠ¸ìœ— ê²€ìƒ‰ ê²°ê³¼ -->
            <div id="tweets-tab" class="tab-content">
                {% if tweets %}
                    {% for tweet in tweets %}
                    <div class="tweet-card" data-tweet-id="{{ tweet.id }}">
                        <div class="tweet-content-wrapper">
                            <div class="avatar">
                                {{ tweet.author.name[0] if tweet.author.name else 'U' }}
                            </div>
                            
                            <div class="tweet-body">
                                <div class="tweet-header">
                                    <a href="{{ url_for('user_profile', username=tweet.author.username) }}" style="text-decoration: none;">
                                        <span class="tweet-author">{{ tweet.author.name }}</span>
                                        <span class="tweet-username">@{{ tweet.author.username }}</span>
                                    </a>
                                    <span class="tweet-dot">Â·</span>
                                    <span class="tweet-time">{{ tweet.created_at.strftime('%mì›” %dì¼') }}</span>
                                </div>
                                
                                <div class="tweet-text">
                                    {{ tweet.content | safe | replace(query, '<span style="background: #fff3cd; font-weight: 500;">' + query + '</span>') }}
                                </div>
                                
                                <div class="tweet-actions">
                                    <button class="action-button reply" onclick="showReplyModal({{ tweet.id }}, '{{ tweet.author.name }}', '{{ tweet.content[:50] }}')">
                                        <span class="icon">ğŸ’¬</span>
                                        <span class="count">{{ tweet.replies_count() }}</span>
                                    </button>
                                    
                                    <button class="action-button retweet {% if tweet.is_retweeted_by(user) %}active{% endif %}" onclick="toggleRetweet({{ tweet.id }}, this)">
                                        <span class="icon">ğŸ”</span>
                                        <span class="count">{{ tweet.retweets_count() }}</span>
                                    </button>
                                    
                                    <button class="action-button like {% if tweet.is_liked_by(user) %}active{% endif %}" onclick="toggleLike({{ tweet.id }}, this)">
                                        <span class="icon">{% if tweet.is_liked_by(user) %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                                        <span class="count">{{ tweet.likes_count() }}</span>
                                    </button>
                                    
                                    <button class="action-button bookmark {% if tweet.is_bookmarked_by(user) %}active{% endif %}" onclick="toggleBookmark({{ tweet.id }}, this)">
                                        <span class="icon">{% if tweet.is_bookmarked_by(user) %}ğŸ”–{% else %}ğŸ“‘{% endif %}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”</div>
                        <h3 style="margin-bottom: 8px;">íŠ¸ìœ—ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>"{{ query }}"ì™€ ì¼ì¹˜í•˜ëŠ” íŠ¸ìœ—ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- í•´ì‹œíƒœê·¸ ê²€ìƒ‰ ê²°ê³¼ -->
            <div id="hashtags-tab" class="tab-content" style="display: none;">
                {% if hashtags %}
                    {% for hashtag in hashtags %}
                    <a href="{{ url_for('hashtag_page', tag=hashtag.tag) }}" style="text-decoration: none; color: inherit; display: block;">
                        <div class="widget-item" style="border-bottom: 1px solid var(--border-color); padding: 16px 20px; transition: background 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 17px; margin-bottom: 4px; color: var(--text-primary);">
                                        #{{ hashtag.tag | replace(query, '<span style="background: #fff3cd; font-weight: 500;">' + query + '</span>') | safe }}
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: 13px;">
                                        {{ hashtag.tweet_count() }} íŠ¸ìœ—
                                    </div>
                                </div>
                                <div style="font-size: 24px; opacity: 0.5;">
                                    ğŸ“Œ
                                </div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ·ï¸</div>
                        <h3 style="margin-bottom: 8px;">í•´ì‹œíƒœê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>"{{ query }}"ì™€ ì¼ì¹˜í•˜ëŠ” í•´ì‹œíƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                {% endif %}
            </div>
            
        {% else %}
            <!-- ê²€ìƒ‰ì–´ ì…ë ¥ ì „ -->
            <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                <div style="font-size: 64px; margin-bottom: 16px;">ğŸ”</div>
                <h3 style="margin-bottom: 8px;">Twitter ê²€ìƒ‰</h3>
                <p style="margin-bottom: 24px;">íŠ¸ìœ—ê³¼ í•´ì‹œíƒœê·¸ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”</p>
                
                <div style="max-width: 400px; margin: 0 auto; text-align: left;">
                    <h4 style="font-size: 15px; font-weight: bold; margin-bottom: 12px; color: var(--text-primary);">ğŸ’¡ ê²€ìƒ‰ íŒ</h4>
                    <ul style="font-size: 14px; line-height: 1.8; padding-left: 20px;">
                        <li>í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ë©´ ê´€ë ¨ íŠ¸ìœ—ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                        <li>í•´ì‹œíƒœê·¸ë„ í•¨ê»˜ ê²€ìƒ‰ë©ë‹ˆë‹¤</li>
                        <li>ê²€ìƒ‰ì€ ëŒ€ì†Œë¬¸ìë¥¼ êµ¬ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</li>
                    </ul>
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” -->
    <div class="right-sidebar">
        <div class="widget">
            <div class="widget-header">
                ì¸ê¸° ê²€ìƒ‰ì–´
            </div>
            <a href="{{ url_for('search') }}?q=íŒŒì´ì¬" style="color: var(--text-primary); text-decoration: none; padding: 16px; display: block; border-bottom: 1px solid var(--border-color);">
                <div style="font-weight: 500;">íŒŒì´ì¬</div>
                <div style="color: var(--text-secondary); font-size: 13px; margin-top: 4px;">Python í”„ë¡œê·¸ë˜ë°</div>
            </a>
            <a href="{{ url_for('search') }}?q=Flask" style="color: var(--text-primary); text-decoration: none; padding: 16px; display: block; border-bottom: 1px solid var(--border-color);">
                <div style="font-weight: 500;">Flask</div>
                <div style="color: var(--text-secondary); font-size: 13px; margin-top: 4px;">ì›¹ í”„ë ˆì„ì›Œí¬</div>
            </a>
            <a href="{{ url_for('trending') }}" style="color: var(--twitter-blue); text-decoration: none; padding: 16px; display: block;">
                íŠ¸ë Œë“œ ë”ë³´ê¸°
            </a>
        </div>
        
        {% if query and (tweets or hashtags) %}
        <div class="widget">
            <div class="widget-header">
                ê²€ìƒ‰ ê²°ê³¼ ìš”ì•½
            </div>
            <div style="padding: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span style="color: var(--text-secondary);">íŠ¸ìœ—</span>
                    <span style="font-weight: bold;">{{ tweets|length }}ê°œ</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">í•´ì‹œíƒœê·¸</span>
                    <span style="font-weight: bold;">{{ hashtags|length }}ê°œ</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- ë‹µê¸€ ëª¨ë‹¬ -->
<div id="replyModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <button onclick="closeReplyModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%;">âœ•</button>
            <h3 style="font-size: 20px; font-weight: bold;">ë‹µê¸€ ì‘ì„±</h3>
            <div style="width: 36px;"></div>
        </div>
        
        <div style="padding: 16px;">
            <div id="originalTweet" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; color: var(--text-secondary); font-size: 15px;"></div>
            
            <div style="display: flex; gap: 12px;">
                <div class="avatar">{{ user.name[0] if user.name else 'U' }}</div>
                <div style="flex: 1;">
                    <textarea id="replyTextarea" placeholder="ë‹µê¸€ íŠ¸ìœ—í•˜ê¸°" style="width: 100%; border: none; outline: none; font-size: 17px; font-family: inherit; resize: none; min-height: 100px;" maxlength="300"></textarea>
                </div>
            </div>
        </div>
        
        <div style="padding: 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
            <button id="replyButton" class="post-button" onclick="submitReply()">ë‹µê¸€</button>
        </div>
    </div>
</div>

<style>
.search-tab {
    flex: 1;
    padding: 16px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-secondary);
    transition: all 0.2s;
}

.search-tab:hover {
    background: var(--background-secondary);
}

.search-tab.active {
    color: var(--text-primary);
    border-bottom-color: var(--twitter-blue);
}

.tab-content {
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.widget-item:hover {
    background: var(--background-secondary);
}

.action-button.active.like {
    color: #F91880;
}

.action-button.active.like .icon {
    color: #F91880;
}

.action-button.active.retweet {
    color: #17BF63;
}

.action-button.active.retweet .icon {
    color: #17BF63;
}

.action-button.active.bookmark {
    color: var(--twitter-blue);
}
</style>

<script>
let currentReplyTweetId = null;

// íƒ­ ì „í™˜
function showTab(tabName) {
    // ëª¨ë“  íƒ­ ë²„íŠ¼ê³¼ ì½˜í…ì¸  ë¹„í™œì„±í™”
    document.querySelectorAll('.search-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
    
    // ì„ íƒí•œ íƒ­ í™œì„±í™”
    event.target.closest('.search-tab').classList.add('active');
    document.getElementById(tabName + '-tab').style.display = 'block';
}

// ì¢‹ì•„ìš” í† ê¸€
async function toggleLike(tweetId, button) {
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/like/${tweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const icon = button.querySelector('.icon');
            const count = button.querySelector('.count');
            
            if (data.action === 'liked') {
                icon.textContent = 'â¤ï¸';
                button.classList.add('active');
            } else {
                icon.textContent = 'ğŸ¤';
                button.classList.remove('active');
            }
            
            count.textContent = data.count;
        }
    } catch (error) {
        console.error('Error:', error);
    } finally {
        button.disabled = false;
    }
}

// ë¦¬íŠ¸ìœ— í† ê¸€
async function toggleRetweet(tweetId, button) {
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/retweet/${tweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const count = button.querySelector('.count');
            
            if (data.action === 'retweeted') {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
            
            count.textContent = data.count;
        }
    } catch (error) {
        console.error('Error:', error);
    } finally {
        button.disabled = false;
    }
}

// ë¶ë§ˆí¬ í† ê¸€
async function toggleBookmark(tweetId, button) {
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/bookmark/${tweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const icon = button.querySelector('.icon');
            
            if (data.action === 'bookmarked') {
                icon.textContent = 'ğŸ”–';
                button.classList.add('active');
            } else {
                icon.textContent = 'ğŸ“‘';
                button.classList.remove('active');
            }
        }
    } catch (error) {
        console.error('Error:', error);
    } finally {
        button.disabled = false;
    }
}

// ë‹µê¸€ ëª¨ë‹¬ ì—´ê¸°
function showReplyModal(tweetId, authorName, content) {
    currentReplyTweetId = tweetId;
    document.getElementById('originalTweet').innerHTML = `
        <strong>${authorName}</strong>ë‹˜ì—ê²Œ ë³´ë‚´ëŠ” ë‹µê¸€<br>
        <span style="color: var(--text-primary); margin-top: 8px; display: block;">${content}${content.length > 50 ? '...' : ''}</span>
    `;
    document.getElementById('replyModal').style.display = 'flex';
    document.getElementById('replyTextarea').focus();
}

// ë‹µê¸€ ëª¨ë‹¬ ë‹«ê¸°
function closeReplyModal() {
    document.getElementById('replyModal').style.display = 'none';
    document.getElementById('replyTextarea').value = '';
    currentReplyTweetId = null;
}

// ë‹µê¸€ ì œì¶œ
async function submitReply() {
    const content = document.getElementById('replyTextarea').value.trim();
    if (!content) return;
    
    const button = document.getElementById('replyButton');
    button.disabled = true;
    button.textContent = 'ë‹µê¸€ ì¤‘...';
    
    try {
        const response = await fetch(`/api/reply/${currentReplyTweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content })
        });
        
        if (response.ok) {
            closeReplyModal();
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'ë‹µê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
        button.disabled = false;
        button.textContent = 'ë‹µê¸€';
    }
}

// ESCí‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeReplyModal();
    }
});

// ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('replyModal').addEventListener('click', (e) => {
    if (e.target.id === 'replyModal') {
        closeReplyModal();
    }
});
</script>
{% endblock %}