{% extends "base.html" %}

{% block title %}í™ˆ / Twitter{% endblock %}

{% block content %}
<div class="twitter-container">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <div class="left-sidebar">
        <a href="{{ url_for('timeline') }}" class="logo">
            ğŸ¦
        </a>
        
        <nav>
            <a href="{{ url_for('timeline') }}" class="nav-item active">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-text">í™ˆ</span>
            </a>
            
            <a href="{{ url_for('explore') }}" class="nav-item">
                <span class="nav-icon">ğŸ”</span>
                <span class="nav-text">íƒìƒ‰í•˜ê¸°</span>
            </a>
            
            <a href="{{ url_for('notifications') }}" class="nav-item">
                <span class="nav-icon">ğŸ””</span>
                <span class="nav-text">ì•Œë¦¼</span>
                {% if user.unread_notifications_count() > 0 %}
                <span style="background: var(--twitter-blue); color: white; border-radius: 50%; padding: 2px 8px; font-size: 12px; margin-left: 8px;">
                    {{ user.unread_notifications_count() }}
                </span>
                {% endif %}
            </a>
            
            <a href="{{ url_for('messages') }}" class="nav-item">
                <span class="nav-icon">âœ‰ï¸</span>
                <span class="nav-text">ìª½ì§€</span>
                {% if user.unread_messages_count() > 0 %}
                <span style="background: var(--twitter-blue); color: white; border-radius: 50%; padding: 2px 8px; font-size: 12px; margin-left: 8px;">
                    {{ user.unread_messages_count() }}
                </span>
                {% endif %}
            </a>
            
            <a href="{{ url_for('bookmarks') }}" class="nav-item">
                <span class="nav-icon">ğŸ”–</span>
                <span class="nav-text">ë¶ë§ˆí¬</span>
            </a>
            
            <a href="{{ url_for('users_list') }}" class="nav-item">
                <span class="nav-icon">ğŸ‘¥</span>
                <span class="nav-text">ì‚¬ìš©ì</span>
            </a>
            
            <a href="{{ url_for('profile') }}" class="nav-item">
                <span class="nav-icon">ğŸ‘¤</span>
                <span class="nav-text">í”„ë¡œí•„</span>
            </a>
            
            <a href="{{ url_for('logout') }}" class="nav-item">
                <span class="nav-icon">ğŸšª</span>
                <span class="nav-text">ë¡œê·¸ì•„ì›ƒ</span>
            </a>
        </nav>
        
        <button class="tweet-button" onclick="document.getElementById('tweetTextarea').focus()">
            <span class="nav-text">íŠ¸ìœ—í•˜ê¸°</span>
            <span class="nav-icon" style="display: none;">âœï¸</span>
        </button>
    </div>
    
    <!-- ì¤‘ì•™ í”¼ë“œ -->
    <div class="main-feed">
        <div class="feed-header">
            í™ˆ
        </div>
        
        <!-- íŠ¸ìœ— ì‘ì„± -->
        <div class="tweet-compose">
            <div class="compose-wrapper">
                <div class="avatar">
                    {{ user.name[0] if user.name else 'U' }}
                </div>
                
                <div class="compose-input">
                    <textarea 
                        id="tweetTextarea"
                        class="compose-textarea" 
                        placeholder="ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚˜ê³  ìˆë‚˜ìš”?"
                        maxlength="300"
                    ></textarea>
                    
                    <div class="compose-actions">
                        <div class="compose-icons">
                            <button class="icon-button" title="ì´ë¯¸ì§€">ğŸ“·</button>
                            <button class="icon-button" title="GIF">ğŸ¬</button>
                            <button class="icon-button" title="ì´ëª¨ì§€">ğŸ˜Š</button>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <span id="charCount" style="color: var(--text-secondary); font-size: 13px;">0 / 300</span>
                            <button class="post-button" id="postButton" disabled>íŠ¸ìœ—í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- íƒ€ì„ë¼ì¸ -->
        <div id="timeline">
            {% if tweets %}
                {% for tweet in tweets %}
                <div class="tweet-card" data-tweet-id="{{ tweet.id }}">
                    <div class="tweet-content-wrapper">
                        <div class="avatar">
                            {{ tweet.author.name[0] if tweet.author.name else 'U' }}
                        </div>
                        
                        <div class="tweet-body">
                            <div class="tweet-header">
                                <span class="tweet-author">{{ tweet.author.name }}</span>
                                <span class="tweet-username">@{{ tweet.author.username }}</span>
                                <span class="tweet-dot">Â·</span>
                                <span class="tweet-time">{{ tweet.created_at.strftime('%mì›” %dì¼') }}</span>
                            </div>
                            
                            <div class="tweet-text">
                                {{ tweet.content }}
                            </div>
                            
                            <div class="tweet-actions">
                                <button class="action-button reply" onclick="showReplyModal({{ tweet.id }}, '{{ tweet.author.name }}', '{{ tweet.content[:50] }}')">
                                    <span class="icon">ğŸ’¬</span>
                                    <span class="count">{{ tweet.replies_count() }}</span>
                                </button>
                                
                                <button class="action-button retweet {% if tweet.is_retweeted_by(user) %}active{% endif %}" onclick="toggleRetweet({{ tweet.id }}, this)">
                                    <span class="icon">ğŸ”</span>
                                    <span class="count">{{ tweet.retweets_count() }}</span>
                                </button>
                                
                                <button class="action-button like {% if tweet.is_liked_by(user) %}active{% endif %}" onclick="toggleLike({{ tweet.id }}, this)">
                                    <span class="icon">{% if tweet.is_liked_by(user) %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                                    <span class="count">{{ tweet.likes_count() }}</span>
                                </button>
                                
                                <button class="action-button bookmark {% if tweet.is_bookmarked_by(user) %}active{% endif %}" onclick="toggleBookmark({{ tweet.id }}, this)">
                                    <span class="icon">{% if tweet.is_bookmarked_by(user) %}ğŸ”–{% else %}ğŸ“‘{% endif %}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¦</div>
                    <h3 style="margin-bottom: 8px;">íƒ€ì„ë¼ì¸ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</h3>
                    <p>ì²« íŠ¸ìœ—ì„ ì‘ì„±í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì‚¬ìš©ìë¥¼ íŒ”ë¡œìš°í•´ë³´ì„¸ìš”!</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” -->
    <div class="right-sidebar">
        <div class="search-box">
            <input type="text" class="search-input" placeholder="Twitter ê²€ìƒ‰">
        </div>
        
        <div class="widget">
            <div class="widget-header">
                ë‚˜ë¥¼ ìœ„í•œ íŠ¸ë Œë“œ
            </div>
            <div class="widget-item">
                <div style="color: var(--text-secondary); font-size: 13px;">ëŒ€í•œë¯¼êµ­ì—ì„œ íŠ¸ë Œë“œ</div>
                <div style="font-weight: bold; margin: 4px 0;">#Flask</div>
                <div style="color: var(--text-secondary); font-size: 13px;">1,234 íŠ¸ìœ—</div>
            </div>
            <div class="widget-item">
                <div style="color: var(--text-secondary); font-size: 13px;">ê¸°ìˆ  Â· íŠ¸ë Œë”©</div>
                <div style="font-weight: bold; margin: 4px 0;">#Python</div>
                <div style="color: var(--text-secondary); font-size: 13px;">5,678 íŠ¸ìœ—</div>
            </div>
        </div>
    </div>
</div>

<!-- ë‹µê¸€ ëª¨ë‹¬ -->
<div id="replyModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <button onclick="closeReplyModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%;">âœ•</button>
            <h3 style="font-size: 20px; font-weight: bold;">ë‹µê¸€ ì‘ì„±</h3>
            <div style="width: 36px;"></div>
        </div>
        
        <div style="padding: 16px;">
            <div id="originalTweet" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; color: var(--text-secondary); font-size: 15px;"></div>
            
            <div style="display: flex; gap: 12px;">
                <div class="avatar">{{ user.name[0] if user.name else 'U' }}</div>
                <div style="flex: 1;">
                    <textarea id="replyTextarea" placeholder="ë‹µê¸€ íŠ¸ìœ—í•˜ê¸°" style="width: 100%; border: none; outline: none; font-size: 17px; font-family: inherit; resize: none; min-height: 100px;" maxlength="300"></textarea>
                </div>
            </div>
        </div>
        
        <div style="padding: 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
            <button id="replyButton" class="post-button" onclick="submitReply()">ë‹µê¸€</button>
        </div>
    </div>
</div>

<style>
.action-button.active.like {
    color: #F91880;
}

.action-button.active.like .icon {
    color: #F91880;
}

.action-button.active.retweet {
    color: #17BF63;
}

.action-button.active.retweet .icon {
    color: #17BF63;
}

.action-button.active.bookmark {
    color: var(--twitter-blue);
}
</style>

<script>
const textarea = document.getElementById('tweetTextarea');
const postButton = document.getElementById('postButton');
const charCount = document.getElementById('charCount');
let currentReplyTweetId = null;

// ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸
textarea.addEventListener('input', () => {
    const length = textarea.value.length;
    charCount.textContent = `${length} / 300`;
    postButton.disabled = length === 0 || length > 300;
    
    if (length > 300) {
        charCount.style.color = '#F91880';
    } else {
        charCount.style.color = 'var(--text-secondary)';
    }
});

// íŠ¸ìœ— ì‘ì„±
postButton.addEventListener('click', async () => {
    const content = textarea.value.trim();
    if (!content) return;
    
    postButton.disabled = true;
    postButton.textContent = 'ê²Œì‹œ ì¤‘...';
    
    try {
        const response = await fetch('/api/tweet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'íŠ¸ìœ— ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            postButton.disabled = false;
            postButton.textContent = 'íŠ¸ìœ—í•˜ê¸°';
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        postButton.disabled = false;
        postButton.textContent = 'íŠ¸ìœ—í•˜ê¸°';
    }
});

// Enterí‚¤ë¡œ íŠ¸ìœ—
textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!postButton.disabled) {
            postButton.click();
        }
    }
});

// ì¢‹ì•„ìš” í† ê¸€
async function toggleLike(tweetId, button) {
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/like/${tweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const icon = button.querySelector('.icon');
            const count = button.querySelector('.count');
            
            if (data.action === 'liked') {
                icon.textContent = 'â¤ï¸';
                button.classList.add('active');
            } else {
                icon.textContent = 'ğŸ¤';
                button.classList.remove('active');
            }
            
            count.textContent = data.count;
        }
    } catch (error) {
        console.error('Error:', error);
    } finally {
        button.disabled = false;
    }
}

// ë¦¬íŠ¸ìœ— í† ê¸€
async function toggleRetweet(tweetId, button) {
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/retweet/${tweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const count = button.querySelector('.count');
            
            if (data.action === 'retweeted') {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
            
            count.textContent = data.count;
        }
    } catch (error) {
        console.error('Error:', error);
    } finally {
        button.disabled = false;
    }
}

// ë¶ë§ˆí¬ í† ê¸€
async function toggleBookmark(tweetId, button) {
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/bookmark/${tweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const icon = button.querySelector('.icon');
            
            if (data.action === 'bookmarked') {
                icon.textContent = 'ğŸ”–';
                button.classList.add('active');
            } else {
                icon.textContent = 'ğŸ“‘';
                button.classList.remove('active');
            }
        }
    } catch (error) {
        console.error('Error:', error);
    } finally {
        button.disabled = false;
    }
}

// ë‹µê¸€ ëª¨ë‹¬ ì—´ê¸°
function showReplyModal(tweetId, authorName, content) {
    currentReplyTweetId = tweetId;
    document.getElementById('originalTweet').innerHTML = `
        <strong>${authorName}</strong>ë‹˜ì—ê²Œ ë³´ë‚´ëŠ” ë‹µê¸€<br>
        <span style="color: var(--text-primary); margin-top: 8px; display: block;">${content}${content.length > 50 ? '...' : ''}</span>
    `;
    document.getElementById('replyModal').style.display = 'flex';
    document.getElementById('replyTextarea').focus();
}

// ë‹µê¸€ ëª¨ë‹¬ ë‹«ê¸°
function closeReplyModal() {
    document.getElementById('replyModal').style.display = 'none';
    document.getElementById('replyTextarea').value = '';
    currentReplyTweetId = null;
}

// ë‹µê¸€ ì œì¶œ
async function submitReply() {
    const content = document.getElementById('replyTextarea').value.trim();
    if (!content) return;
    
    const button = document.getElementById('replyButton');
    button.disabled = true;
    button.textContent = 'ë‹µê¸€ ì¤‘...';
    
    try {
        const response = await fetch(`/api/reply/${currentReplyTweetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content })
        });
        
        if (response.ok) {
            closeReplyModal();
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'ë‹µê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
        button.disabled = false;
        button.textContent = 'ë‹µê¸€';
    }
}

// ESCí‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeReplyModal();
    }
});

// ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('replyModal').addEventListener('click', (e) => {
    if (e.target.id === 'replyModal') {
        closeReplyModal();
    }
});
</script>
{% endblock %}
